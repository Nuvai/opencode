#!/usr/bin/env bash
#
# OpenCode Uninstall Script
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/Nuvai/opencode/main/uninstall | bash
#   ./uninstall [--all]
#
# Options:
#   --all    Remove everything including config (~/.opencode)
#

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
MUTED='\033[0;2m'
NC='\033[0m'

INSTALL_DIR="$HOME/.opencode/bin"
CONFIG_DIR="$HOME/.opencode"
REMOVE_ALL=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --all)
            REMOVE_ALL=true
            shift
            ;;
        -h|--help)
            echo "Usage: uninstall [--all]"
            echo ""
            echo "Options:"
            echo "  --all    Remove everything including config (~/.opencode)"
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

echo -e "${MUTED}Uninstalling OpenCode...${NC}"

# Remove binary
if [[ -f "$INSTALL_DIR/opencode" ]]; then
    rm -f "$INSTALL_DIR/opencode"
    echo -e "${GREEN}✓${NC} Removed $INSTALL_DIR/opencode"
else
    echo -e "${YELLOW}!${NC} Binary not found at $INSTALL_DIR/opencode"
fi

# Remove bin directory if empty
if [[ -d "$INSTALL_DIR" ]] && [[ -z "$(ls -A "$INSTALL_DIR" 2>/dev/null)" ]]; then
    rmdir "$INSTALL_DIR" 2>/dev/null || true
    echo -e "${GREEN}✓${NC} Removed empty $INSTALL_DIR"
fi

# Remove all config if requested
if [[ "$REMOVE_ALL" == "true" ]]; then
    if [[ -d "$CONFIG_DIR" ]]; then
        rm -rf "$CONFIG_DIR"
        echo -e "${GREEN}✓${NC} Removed $CONFIG_DIR"
    fi
fi

# Check for PATH entries in shell configs
echo ""
echo -e "${MUTED}Note: You may want to remove the PATH export from your shell config:${NC}"
echo -e "  ${YELLOW}export PATH=\"$INSTALL_DIR:\$PATH\"${NC}"
echo ""

# Check common shell configs
for config in "$HOME/.zshrc" "$HOME/.bashrc" "$HOME/.bash_profile" "$HOME/.profile"; do
    if [[ -f "$config" ]] && grep -q "$INSTALL_DIR" "$config" 2>/dev/null; then
        echo -e "  Found in: $config"
    fi
done

echo ""
echo -e "${GREEN}OpenCode uninstalled.${NC}"
